<!DOCTYPE html>
<html>
    <head>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
        <script type="text/javascript">
            $(function(){

                var Cell = Backbone.Model.extend({
                    defaults: {
                        value: "_",
                        isSelected: false
                    }
                });

                var CellView = Backbone.View.extend({
                    tagName: "div",

                    template:  _.template($("#cellTemplate").html()),

                    attributes: {
                        "class" : "sudoku-cell"
                    },

                    events: {
                        "click": "clickListener"
                    },

                    initialize: function(){
                        this.listenTo(this.model, "change", this.render);
                    },

                    clickListener: function(){
                        this.model.trigger("click", this.model);
                    },

                    render: function(){
                        this.$el.html(this.template(this.model.toJSON()));

                        if (this.model.collection.length == 81
                            && [3,4,5,12,13,14,21,22,23,27,28,29,33,34,35,36,37,38,42,43,44,45,46,47,51,52,53,57,58,59,66,67,68,75,76,77]
                                .indexOf(this.model.collection.indexOf(this.model)) > -1){
                            this.$el.addClass('sudoku-group-cell-2');
                        }

                        if (this.model.get("isSelected")){
                            this.$el.addClass("is-selected");
                        } else {
                            this.$el.removeClass("is-selected");
                        }

                        return this;
                    }
                });

                var Cells = Backbone.Collection.extend({
                    model: Cell,

                    initialize: function(){
                        var self = this;
                        for (var i = 0; i < 81; i++){
                            self.add({});
                        }

                        self.listenTo(self, "change:isSelected", self.changeIsSelectedListener);
                    },

                    changeIsSelectedListener: function(changedCell){
                        var self = this;
                        if (changedCell.get("isSelected")){
                            self.each(function(cell){
                                if (cell != changedCell){
                                    cell.set("isSelected", false);
                                }
                            });
                        }
                    }
                });

                var App = Backbone.View.extend({

                    events: {
                        "keypress": "keypressListener"
                    },

                    initialize: function(){
                        var self = this;

                        self.cells = new Cells();
                        self.cells.at(0).set("isSelected", true);
                        self.listenTo(self.cells, "click", self.cellClicked);
                        
                        var controlsJSON = [];
                        for (var i = 1; i < 10; i++){
                            controlsJSON.push({'value': i.toString()});
                        }
                        self.controls = new Cells(controlsJSON);
                        self.listenTo(self.controls, "click", self.controlClicked);

                    },

                    keypressListener: function(eventData){
                        var self = this;
                        self.setSelectedCellToValue(self.convertKeyCodeToSudokuValue(eventData.keyCode));
                    },

                    convertKeyCodeToSudokuValue: function(keyCode){
                        switch (keyCode){
                            case 49:
                                return "1";
                            case 50:
                                return "2";
                            case 51:
                                return "3";
                            case 52:
                                return "4";
                            case 53:
                                return "5";
                            case 54:
                                return "6";
                            case 55:
                                return "7";
                            case 56:
                                return "8";
                            case 57:
                                return "9";
                            default:
                                return "";
                        }
                    },

                    controlClicked: function(control){
                        var self = this;
                        if ("123456789".indexOf(control.get("value")) > -1){
                            self.setSelectedCellToValue(control.get("value"));
                        }
                    },

                    setSelectedCellToValue: function(value){
                        var self = this;
                        self.cells.findWhere({"isSelected" : true}).set("value", value);
                        self.selectNextCell();
                    },

                    selectNextCell: function(){
                        var self = this;
                        var indexOfCurrentSelectedCell = self.cells.indexOf(self.cells.findWhere({"isSelected" : true}));
                        var nextCell = indexOfCurrentSelectedCell < 80 ? indexOfCurrentSelectedCell + 1 : 0;
                        self.cells.at(nextCell).set("isSelected", true);
                    },

                    cellClicked: function(cell){
                        cell.set("isSelected", true);
                    },

                    render: function(){
                        this.renderBoard();
                        this.renderControls();
                        return this;
                    },

                    renderBoard: function(){
                        var self = this;
                        var $board = self.$el.find("#board");
                        $board.html("");
                        self.cells.each(function(cell, iterator){
                            if (iterator % 9 == 0) {
                                $board.append("<div class='sudoku-row'></div>");
                            }
                            var cellView = new CellView({model: cell});
                            $board.find(".sudoku-row").last().append(cellView.render().$el);
                        });
                    },

                    renderControls: function(){
                        var self = this;
                        var $controls = self.$el.find("#controls");
                        $controls.html("");
                        $controls.append("<div class='sudoku-row'></div>");
                        self.controls.each(function(cell){
                            var cellView = new CellView({model: cell});
                            $controls.find(".sudoku-row").append(cellView.render().$el);
                        });
                    }
                });

                testing = new App({
                    el: "#sudoku"
                }).render();
            });
        </script>
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'>
        <style>
            ::selection {
                color: black;
            }
            body {
                background-color: #B8AE9C;
                font-family: 'Droid Sans', sans-serif;
            }

            .sudoku-row {
                margin-bottom: 10px;
                width: 100%;
            }

            .sudoku-cell {
                background-color: #FFFFFF;
                box-shadow: 1px 1px 4px #595241;
                cursor: pointer;
                display: inline-block;
                font-size: 50px;
                height: 60px;
                overflow: hidden;
                text-align: center;
                width: 60px;
            }

            .sudoku-cell.is-selected {
                background-color: yellow;
            }

            .sudoku-cell + .sudoku-cell {
                margin-left: 10px;
            }

            .sudoku-group-cell-2 {
                background-color: #ACCFCC;
            }
        </style>
    </head>
    <body id="sudoku">
        <script type="text/template" id="cellTemplate">
            <%= value %>
        </script>

        <div id="board"></div>
        <hr>
        <div id="controls"></div>
    </body>
</html>
